<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chess.com Accuracy & Performance Calculator</title>
<style>
  body{font-family:sans-serif;max-width:760px;margin:2rem auto;padding:0 1rem;line-height:1.4}
  textarea{width:100%;height:240px}
  input,button{padding:.5rem;font-size:1rem;margin-top:.5rem}
  pre{background:#f6f6f6;padding:1rem;border-radius:6px;overflow:auto}
  table{border-collapse:collapse;margin-top:1rem;width:100%}
  th,td{border:1px solid #ccc;padding:.4rem;text-align:center}
  th{background:#eee}
  caption{margin-bottom:.4rem;font-weight:bold}
</style>
</head>
<body>
<h2>Chess.com Accuracy / Performance Stats</h2>

<label>Player username (leave blank to auto-detect):<br>
  <input id="player" placeholder="e.g. robdragon">
</label>

<p>Paste the raw “Recent” games listing, then click <b>Calculate</b>.</p>
<textarea id="input" placeholder="Paste here…"></textarea><br>
<button onclick="calc()">Calculate</button>

<div id="output"></div>

<script>
function calc(){
  const txt   = document.getElementById('input').value;
  const outEl = document.getElementById('output');
  if(!txt.trim()){ outEl.textContent = 'Please paste some game text first.'; return; }

  const blocks = txt.split(/\n(?=\d+\s+min)/);
  if(!blocks.length){ outEl.textContent = 'No games detected.'; return; }

  /* ---------- detect player name if blank ---------- */
  let player = document.getElementById('player').value.trim();
  if(!player){
    const freq={};
    blocks.forEach(b=>[...b.matchAll(/([A-Za-z0-9_]+)\s*\(\d+\)/g)]
      .forEach(m=>freq[m[1]] = (freq[m[1]]||0)+1));
    player = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0]?.[0]||'';
    if(!player){ outEl.textContent = 'Could not auto-detect username.'; return; }
  }

  /* ---------- containers ---------- */
  const make = ()=>({acc:[], wins:0, losses:0, opp:[]});
  const you  = {all:make(), white:make(), black:make()};
  const opp  = {all:make(), white:make(), black:make()};
  const daily = {};  /* keyed by date string */

  const scoreVal = s => (s==='½'||s==='0.5') ? 0.5 : parseFloat(s);
  const avg   = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : NaN;
  const perf  = o => {
      const g=o.wins+o.losses;
      return g? ((o.wins-o.losses)/g)*400 + avg(o.opp) : NaN;
  };
  const fmt   = x => isNaN(x) ? '—' : x.toFixed(2);
  const estRt = a => isNaN(a) ? '—' : ((a-64)*100).toFixed(0);

  /* ---------- game loop ---------- */
  blocks.forEach(block=>{
    const nm = [...block.matchAll(/([A-Za-z0-9_]+)\s*\((\d+)\)/g)];
    if(nm.length<2) return;

    const [whiteN,whiteE] = [nm[0][1], +nm[0][2]];
    const [blackN,blackE] = [nm[1][1], +nm[1][2]];
    const colour = player.toLowerCase()===whiteN.toLowerCase() ? 'white'
                 : player.toLowerCase()===blackN.toLowerCase() ? 'black' : null;
    if(!colour) return;

    const after = block.slice(nm[1].index + nm[1][0].length);
    const res   = [...after.matchAll(/\b(?:1|0|½|0\.5)\b/g)].slice(0,2).map(m=>scoreVal(m[0]));
    if(res.length<2) return;
    const [wScr,bScr] = res;

    const accNums = [...after.matchAll(/\b\d{1,3}(?:\.\d+)?\b/g)]
                    .map(m=>+m[0]).filter(n=>n>=5&&n<=100).slice(0,2);
    if(accNums.length<2) return;
    const [wAcc,bAcc] = accNums;

    /* date extraction */
    const dateMatch = block.match(/\b[A-Z][a-z]{2} \d{1,2}, \d{4}\b/);
    const dKey = dateMatch?dateMatch[0]:'Unknown';

    const youAcc   = colour==='white'?wAcc:bAcc;
    const oppAcc   = colour==='white'?bAcc:wAcc;
    const oppElo   = colour==='white'?blackE:whiteE;
    const youWin   = (colour==='white' && wScr>bScr) || (colour==='black' && bScr>wScr);
    const youLoss  = (colour==='white' && wScr<bScr) || (colour==='black' && bScr<wScr);
    const oppCol   = colour==='white'?'black':'white';

    /* -- push to your stats -- */
    ['all',colour].forEach(k=>{
      you[k].acc.push(youAcc);
      you[k].opp.push(oppElo);
      if(youWin)  you[k].wins++;
      if(youLoss) you[k].losses++;
    });

    /* -- push to opponent combined stats (draws ignored) -- */
    if(youWin||youLoss){
      ['all',oppCol].forEach(k=>{
        opp[k].acc.push(oppAcc);
        opp[k].opp.push(colour==='white'?whiteE:blackE);
        if(youLoss) opp[k].wins++;  /* they won */
        if(youWin)  opp[k].losses++;
      });
    }

    /* -- daily bucket -- */
    if(!daily[dKey]) daily[dKey]=make();
    daily[dKey].acc.push(youAcc);
    daily[dKey].opp.push(oppElo);
    if(youWin)  daily[dKey].wins++;
    if(youLoss) daily[dKey].losses++;
  });

  /* ---------- build textual summary ---------- */
  const summary =
`Stats for ${player}

YOUR average accuracy:
  Overall : ${fmt(avg(you.all.acc))} Acc -> Rating ${fmt((avg(you.all.acc)-64)*100)}
  White   : ${fmt(avg(you.white.acc))} Acc -> Rating ${fmt((avg(you.white.acc)-64)*100)}
  Black   : ${fmt(avg(you.black.acc))} Acc -> Rating ${fmt((avg(you.black.acc)-64)*100)}

YOUR performance rating:
  Overall : ${fmt(perf(you.all))}
  White   : ${fmt(perf(you.white))}
  Black   : ${fmt(perf(you.black))}
  

OPPONENTS’ combined average accuracy:
  Overall : ${fmt(avg(opp.all.acc))}
  White   : ${fmt(avg(opp.white.acc))}   (their games as White)
  Black   : ${fmt(avg(opp.black.acc))}   (their games as Black)

OPPONENTS’ combined performance rating:
  Overall : ${fmt(perf(opp.all))}
  White   : ${fmt(perf(opp.white))}
  Black   : ${fmt(perf(opp.black))}

Games counted:
  You         – Overall ${you.all.acc.length}  |  White ${you.white.acc.length}  |  Black ${you.black.acc.length}
  Opponents   – Overall ${opp.all.acc.length}  |  White ${opp.white.acc.length}  |  Black ${opp.black.acc.length}`;


  /* ---------- build day-by-day table ---------- */
  const rows = Object.keys(daily)
    .sort((a,b)=>new Date(a)-new Date(b))
    .map(d=>{
      const o = daily[d];
      const a = avg(o.acc);
      const perfD = perf(o);
      return `<tr><td>${d}</td><td>${o.acc.length}</td><td>${fmt(a)}</td><td>${estRt(a)}</td><td>${fmt(perfD)}</td><td>${o.wins}-${o.losses}</td></tr>`;
    }).join('');

  const tableHTML =
`<table>
  <caption>Day-by-day summary (you only)</caption>
  <tr><th>Date</th><th>Games</th><th>Avg&nbsp;accuracy</th><th>Est.&nbsp;rating</th><th>Perf.&nbsp;rating</th><th>W-L</th></tr>
  ${rows || '<tr><td colspan="6">No games</td></tr>'}
</table>`;

  /* ---------- inject into page ---------- */
  outEl.innerHTML = `<pre>${summary}</pre>${tableHTML}`;
}
</script>
</body>
</html>
